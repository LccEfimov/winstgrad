{% extends "_base.html" %}
{% block body %}
<div class="d-flex flex-column align-items-center justify-content-center" style="min-height:60vh">
  <div class="spinner-border" role="status"></div>
  <div class="mt-3 text-secondary">Проверяем запуск из Telegram…</div>
  <div id="fallback" class="mt-3 d-none">
    <div class="alert alert-warning">
      Похоже, вы открыли страницу напрямую. Приложение работает только через Telegram.
    </div>
    <a href="https://t.me/WinstGradBot" class="btn btn-primary"><i class="bi bi-telegram"></i> Открыть @WinstGradBot</a>
  </div>
</div>
<script>
(function(){
  const tg = window.Telegram && Telegram.WebApp;
  if(!tg || !tg.initData){
    document.getElementById('fallback').classList.remove('d-none');
    return;
  }
  fetch('/app/auth', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ initData: tg.initData })
  }).then(r=>r.json()).then(j=>{
    if(j.ok){ location.reload(); }
    else{
      document.getElementById('fallback').classList.remove('d-none');
    }
  }).catch(()=>{
    document.getElementById('fallback').classList.remove('d-none');
  });
})();
</script>
{% endblock %}
